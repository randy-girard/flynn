#!/bin/bash
#
# A script to install Flynn from a release (GitHub or local tarball).
# This script is generated by the release script with appropriate settings.
#
# Install source is determined by __INSTALL_SOURCE__ placeholder:
#   - "github": Download from GitHub releases
#   - "tarball": Install from local extracted tarball directory

set -eo pipefail

# These placeholders are replaced at release time
INSTALL_SOURCE="__INSTALL_SOURCE__"
EMBEDDED_VERSION="__FLYNN_VERSION__"
GITHUB_REPO="__GITHUB_REPO__"

VERSION="${FLYNN_VERSION:-${EMBEDDED_VERSION}}"
CONFIG_DIR="/etc/flynn"
BIN_DIR="/usr/local/bin"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Detect OS and architecture
detect_platform() {
  local os arch
  case "$(uname -s)" in
    Linux)  os="linux" ;;
    Darwin) os="darwin" ;;
    *)      fail "unsupported operating system: $(uname -s)" ;;
  esac
  case "$(uname -m)" in
    x86_64|amd64)  arch="amd64" ;;
    i386|i686)     arch="386" ;;
    aarch64|arm64) arch="arm64" ;;
    *)             fail "unsupported architecture: $(uname -m)" ;;
  esac
  echo "${os}-${arch}"
}

PLATFORM="$(detect_platform)"

usage() {
  cat <<USAGE >&2
usage: $0 [options]

A script to install Flynn on Ubuntu 16.04, 18.04, and 24.04.
See https://flynn.io/docs/installation/manual for further information.

OPTIONS:
  -h, --help                       Show this message
  -v, --version VERSION            Install explicit VERSION (e.g. v2024.01.27.0)
  -r, --repo OWNER/REPO            GitHub repository [default: ${GITHUB_REPO}]
  --clean                          Install from a clean state (implies --remove)
  --remove                         Remove existing Flynn installation
  --yes                            Automatic yes to prompts
  --no-ntp                         Don't install ntp package
  --zpool-create-device DEVICE     Device to create the flynn-default zpool on
  --zpool-create-options OPTIONS   Options to pass to 'zpool create'

VARIABLES:
  FLYNN_VERSION          An explicit version to install (e.g. v2024.01.27.0)
  FLYNN_GITHUB_REPO      GitHub repository (e.g. flynn/flynn)
USAGE
}

# Utility functions
timestamp() { date "+%H:%M:%S.%3N"; }
info() { echo -e "\e[1;32m===> $(timestamp) $1\e[0m"; }
warn() { echo -e "\e[1;33m===> $(timestamp) $1\e[0m"; }
fail() { echo -e "\e[1;31m===> $(timestamp) ERROR: $1\e[0m"; exit 1; }
run() { info "running \"$*\""; "$@" || fail "failed to run \"$*\""; }

is_root() { [[ $(id -u) -eq 0 ]]; }
is_ubuntu_noble() { grep -qF "Ubuntu 24.04" /etc/os-release &>/dev/null; }
is_ubuntu_bionic() { grep -qF "Ubuntu 18.04" /etc/os-release &>/dev/null; }
is_ubuntu_xenial() { grep -qF "Ubuntu 16.04" /etc/os-release &>/dev/null; }

check_overlayfs() {
  modprobe "overlay" 2>/dev/null && grep -q "overlay$" /proc/filesystems
}

check_installed() {
  local missing=()
  for bin in $@; do
    if ! which "${bin}" &>/dev/null; then
      missing+=("${bin}")
    fi
  done
  if [[ ${#missing[@]} -gt 0 ]]; then
    fail "this script requires: ${missing[@]}"
  fi
}

do_remove() {
  local assume_yes=$1
  warn "*** WARNING ***"
  warn "About to stop Flynn and remove all existing data"
  if ! $assume_yes; then
    warn "Are you sure this is what you want?"
    echo -n "(yes/no): "
    while read answer; do
      case "${answer}" in
        yes) assume_yes=true; break ;;
        no)  break ;;
        *)   echo -n "Please type 'yes' or 'no': " ;;
      esac
    done
    if ! $assume_yes; then exit; fi
  fi
  info "stopping flynn-host daemon"
  systemctl stop flynn-host || true
  systemctl disable flynn-host || true
  info "killing old containers"
  start-stop-daemon --stop --oknodo --retry 5 --name ".containerinit" || true
  info "destroying ZFS volumes"
  for path in $(grep zfs /proc/mounts 2>/dev/null | cut -d ' ' -f2); do
    umount "${path}" || true
  done
  if which flynn-host &>/dev/null; then
    flynn-host destroy-volumes --include-data || true
  fi
  if zpool list 2>/dev/null | grep -q "flynn-default"; then
    zpool destroy flynn-default || true
  fi
  info "removing Flynn files and directories"
  rm -rf /usr/local/bin/flynn* /var/lib/flynn /etc/flynn \
    /etc/init/flynn-host.conf /lib/systemd/system/flynn-host.service
  info "Flynn successfully removed"
}

setup_apparmor() {
  if [[ ! -d /sys/kernel/security/apparmor ]]; then
    warn "AppArmor is not supported by this kernel. Skipping AppArmor setup."
    return 0
  fi

  local enabled
  enabled=$(cat /sys/module/apparmor/parameters/enabled 2>/dev/null || echo "N")
  if [[ "${enabled}" != "Y" ]]; then
    warn "AppArmor is not enabled in the kernel. Skipping AppArmor setup."
    return 0
  fi

  if ! command -v apparmor_parser &>/dev/null; then
    warn "apparmor_parser not found. Skipping AppArmor profile setup."
    return 0
  fi

  local profile_name="flynn-default"
  local profile_dst="/etc/apparmor.d/${profile_name}"

  info "installing ${profile_name} AppArmor profile"
  cat > "${profile_dst}" <<'APPARMOR_PROFILE'
#include <tunables/global>

profile flynn-default flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  network,
  capability,
  file,
  umount,

  deny @{PROC}/sys/fs/** wklx,
  deny @{PROC}/sysrq-trigger rwklx,
  deny @{PROC}/mem rwklx,
  deny @{PROC}/kmem rwklx,
  deny @{PROC}/kcore rwklx,
  deny @{PROC}/sys/kernel/[^s][^h][^m]* wklx,
  deny @{PROC}/sys/kernel/*/** wklx,

  deny mount,

  deny /sys/[^f]*/** wklx,
  deny /sys/f[^s]*/** wklx,
  deny /sys/fs/[^c]*/** wklx,
  deny /sys/fs/c[^g]*/** wklx,
  deny /sys/fs/cg[^r]*/** wklx,
  deny /sys/firmware/efi/efivars/** rwklx,
  deny /sys/kernel/security/** rwklx,
  deny /sys/kernel/debug/** rwklx,

  deny ptrace (trace) peer=*,
  ptrace (read,readby,tracedby) peer=flynn-default,

  deny /dev/mem rwklx,
  deny /dev/kmem rwklx,
  deny /dev/port rwklx,

  deny /lib/modules/** wklx,
  deny /usr/lib/modules/** wklx,

  signal (send,receive) peer=flynn-default,
  signal (send,receive) peer=unconfined,
}
APPARMOR_PROFILE

  info "loading ${profile_name} AppArmor profile"
  if apparmor_parser -r -W "${profile_dst}" 2>/dev/null || apparmor_parser -a -W "${profile_dst}" 2>/dev/null; then
    info "${profile_name} AppArmor profile loaded successfully"
  else
    warn "failed to load ${profile_name} AppArmor profile. Containers will run without AppArmor confinement."
  fi
}

install_systemd_unit() {
  info "installing systemd unit"
  cat > /lib/systemd/system/flynn-host.service <<EOF
[Unit]
Description=Flynn host daemon
Documentation=https://flynn.io/docs
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/flynn-host daemon
Restart=on-failure
Delegate=yes
KillMode=process
LimitNOFILE=10000

[Install]
WantedBy=multi-user.target
EOF
  systemctl enable flynn-host.service
}

#############################################################################
# GitHub-specific functions
#############################################################################

github_resolve_version() {
  if [[ "${VERSION}" == "latest" ]] || [[ "${VERSION}" == "__FLYNN_VERSION__" ]]; then
    info "fetching latest release version from GitHub..."
    VERSION=$(curl -fsSL "https://api.github.com/repos/${GITHUB_REPO}/releases/latest" | \
      grep -o '"tag_name":[^,]*' | \
      sed 's/"tag_name":[[:space:]]*"//g' | sed 's/"//g')
    if [[ -z "${VERSION}" || "${VERSION}" == "null" ]]; then
      fail "failed to determine latest version from GitHub"
    fi
  fi
}

github_download_checksums() {
  local release_url="https://github.com/${GITHUB_REPO}/releases/download/${VERSION}"
  info "downloading checksums..."
  if ! curl -fsSL -o checksums.sha512 "${release_url}/checksums.sha512"; then
    fail "failed to download checksums from ${release_url}"
  fi
}

github_download_and_install_binary() {
  local asset_name="$1"
  local dest_name="$2"
  local release_url="https://github.com/${GITHUB_REPO}/releases/download/${VERSION}"

  info "downloading ${asset_name}..."
  if ! curl -fsSL -o "${asset_name}" "${release_url}/${asset_name}"; then
    fail "failed to download ${asset_name} from ${release_url}"
  fi

  info "verifying checksum for ${asset_name}..."
  if ! grep "${asset_name}" checksums.sha512 | sha512sum --check --status; then
    fail "checksum verification failed for ${asset_name}"
  fi

  info "installing ${dest_name}..."
  gunzip -f "${asset_name}"
  chmod +x "${asset_name%.gz}"
  mv "${asset_name%.gz}" "${BIN_DIR}/${dest_name}"
}

github_download_and_extract_gz() {
  local asset_name="$1"
  local dest_path="$2"
  local release_url="https://github.com/${GITHUB_REPO}/releases/download/${VERSION}"

  info "downloading ${asset_name}..."
  if ! curl -fsSL -o "${asset_name}" "${release_url}/${asset_name}"; then
    fail "failed to download ${asset_name} from ${release_url}"
  fi

  info "verifying checksum for ${asset_name}..."
  if ! grep "${asset_name}" checksums.sha512 | sha512sum --check --status; then
    fail "checksum verification failed for ${asset_name}"
  fi

  info "extracting to ${dest_path}..."
  gunzip -c "${asset_name}" > "${dest_path}"
}

github_install_layers() {
  local release_url="https://github.com/${GITHUB_REPO}/releases/download/${VERSION}"
  info "downloading container layers (this may take a while)..."

  layer_ids=$(cat "${CONFIG_DIR}/images.json" | \
    grep -o '"id":"[^"]*"' | \
    sed 's/"id":"//g' | sed 's/"//g' | \
    sort -u)

  local layer_count=0
  local layer_total=$(echo "$layer_ids" | wc -w)

  for layer_id in $layer_ids; do
    ((layer_count++)) || true
    if [[ -f "/var/lib/flynn/layer-cache/${layer_id}.squashfs" ]]; then
      info "  [${layer_count}/${layer_total}] ${layer_id} (cached)"
      continue
    fi
    info "  [${layer_count}/${layer_total}] downloading ${layer_id}..."
    if curl -fsSL -o "/var/lib/flynn/layer-cache/${layer_id}.squashfs" \
        "${release_url}/${layer_id}.squashfs" 2>/dev/null; then
      curl -fsSL -o "/var/lib/flynn/layer-cache/${layer_id}.json" \
        "${release_url}/${layer_id}.json" 2>/dev/null || true
    else
      warn "    failed to download ${layer_id}.squashfs"
    fi
  done
  info "  downloaded $(ls /var/lib/flynn/layer-cache/*.squashfs 2>/dev/null | wc -l) layers"
}

#############################################################################
# Tarball-specific functions
#############################################################################

tarball_verify_checksums() {
  info "verifying checksums..."
  if [[ -f "${SCRIPT_DIR}/checksums.sha512" ]]; then
    (cd "${SCRIPT_DIR}" && sha512sum --check --ignore-missing checksums.sha512) || \
      fail "checksum verification failed"
  else
    warn "checksums.sha512 not found, skipping verification"
  fi
}

tarball_install_binaries() {
  info "installing binaries..."
  for gz_file in "${SCRIPT_DIR}"/flynn-host-*.gz "${SCRIPT_DIR}"/flynn-init-*.gz; do
    [[ -f "$gz_file" ]] || continue
    local base=$(basename "$gz_file" .gz)
    local dest="${base%%-linux-*}"
    gunzip -c "$gz_file" > "${BIN_DIR}/${dest}"
    chmod +x "${BIN_DIR}/${dest}"
    info "  installed ${dest}"
  done
}

tarball_install_manifests() {
  info "installing manifests..."
  for gz_file in bootstrap-manifest.json.gz images.json.gz; do
    if [[ -f "${SCRIPT_DIR}/${gz_file}" ]]; then
      gunzip -c "${SCRIPT_DIR}/${gz_file}" > "${CONFIG_DIR}/${gz_file%.gz}"
      info "  installed ${gz_file%.gz}"
    fi
  done
}

tarball_install_image_manifests() {
  if [[ -f "${SCRIPT_DIR}/images.tar.gz" ]]; then
    info "extracting image manifests..."
    mkdir -p "${CONFIG_DIR}/images"
    tar xzf "${SCRIPT_DIR}/images.tar.gz" -C "${CONFIG_DIR}/"
    info "  extracted $(ls ${CONFIG_DIR}/images/*.json 2>/dev/null | wc -l) image manifests"
  fi
}

tarball_install_layers() {
  info "installing layers..."
  local layer_count=0
  for layer_file in "${SCRIPT_DIR}"/*.squashfs; do
    [[ -f "$layer_file" ]] || continue
    cp "$layer_file" "/var/lib/flynn/layer-cache/"
    ((layer_count++)) || true
  done
  for layer_file in "${SCRIPT_DIR}"/*.json; do
    [[ -f "$layer_file" ]] || continue
    [[ "$(basename "$layer_file")" == "checksums.sha512" ]] && continue
    cp "$layer_file" "/var/lib/flynn/layer-cache/" 2>/dev/null || true
  done
  info "  installed ${layer_count} layers"
}


#############################################################################
# Main function
#############################################################################

main() {
  if ! is_root; then
    fail "this script must be executed as the root user"
  fi

  if ! is_ubuntu_xenial && ! is_ubuntu_bionic && ! is_ubuntu_noble; then
    fail "this script is only compatible with Ubuntu 16.04, 18.04, and 24.04"
  fi

  if ! check_overlayfs; then
    fail "OverlayFS is missing or does not support multiple lower directories"
  fi

  if [[ "${INSTALL_SOURCE}" == "github" ]]; then
    check_installed "curl" "sha512sum"
  fi

  local install=true
  local remove=false
  local assume_yes=false
  local install_ntp=true
  local zpool_dev=""
  local zpool_opts=""

  export DEBIAN_FRONTEND=noninteractive

  while true; do
    case "$1" in
      -v|--version)
        if [[ -z "$2" ]]; then fail "--version requires an argument"; fi
        VERSION="$2"
        shift 2
        ;;
      -r|--repo)
        if [[ -z "$2" ]]; then fail "--repo requires an argument"; fi
        GITHUB_REPO="$2"
        shift 2
        ;;
      --clean)
        remove=true
        shift
        ;;
      --remove)
        remove=true
        install=false
        shift
        ;;
      --yes)
        assume_yes=true
        shift
        ;;
      --no-ntp)
        install_ntp=false
        shift
        ;;
      --zpool-create-device)
        if [[ -z "$2" ]]; then fail "--zpool-create-device requires an argument"; fi
        zpool_dev="$2"
        shift 2
        ;;
      --zpool-create-options)
        if [[ -z "$2" ]]; then fail "--zpool-create-options requires an argument"; fi
        zpool_opts="$2"
        shift 2
        ;;
      -h|--help)
        usage
        exit 0
        ;;
      *)
        break
        ;;
    esac
  done

  if [[ $# -ne 0 ]]; then
    usage
    exit 1
  fi

  if $remove; then
    do_remove $assume_yes
  fi

  if [[ -e "${BIN_DIR}/flynn-host" ]]; then
    fail "Flynn is already installed. Run 'flynn-host update' to update, or use --clean to remove first"
  fi

  if ! $install; then
    exit 0
  fi

  # Resolve version for GitHub installs
  if [[ "${INSTALL_SOURCE}" == "github" ]]; then
    github_resolve_version
  fi

  info "installing Flynn ${VERSION} from ${INSTALL_SOURCE}"

  # Install runtime dependencies
  local packages=("iptables" "zfsutils-linux" "jq" "apparmor" "apparmor-utils")
  if $install_ntp; then
    packages+=("ntp")
  fi
  info "installing runtime dependencies"
  run apt-get update
  run apt-get install --yes ${packages[@]}
  info "loading zfs kernel module"
  run modprobe zfs

  # Setup AppArmor profile for container confinement (SEC-007)
  setup_apparmor

  # Create directories
  mkdir -p "${CONFIG_DIR}" "/var/lib/flynn/layer-cache"

  # Source-specific installation
  if [[ "${INSTALL_SOURCE}" == "github" ]]; then
    # Create temp directory for downloads
    local tmp="$(mktemp --directory)"
    trap "rm -rf ${tmp}" EXIT
    cd "${tmp}"

    github_download_checksums
    github_download_and_install_binary "flynn-host-${PLATFORM}.gz" "flynn-host"
    github_download_and_install_binary "flynn-init-${PLATFORM}.gz" "flynn-init"

    if [[ -n "${zpool_dev}" ]]; then
      info "creating flynn-default zpool"
      run zpool create ${zpool_opts} "flynn-default" ${zpool_dev}
    fi

    github_download_and_extract_gz "bootstrap-manifest.json.gz" "${CONFIG_DIR}/bootstrap-manifest.json"
    github_download_and_extract_gz "images.json.gz" "${CONFIG_DIR}/images.json"

    # Download image manifests
    local release_url="https://github.com/${GITHUB_REPO}/releases/download/${VERSION}"
    if curl -fsSL -o "images.tar.gz" "${release_url}/images.tar.gz" 2>/dev/null; then
      info "extracting image manifests..."
      mkdir -p "${CONFIG_DIR}/images"
      tar xzf "images.tar.gz" -C "${CONFIG_DIR}/"
      info "  extracted $(ls ${CONFIG_DIR}/images/*.json 2>/dev/null | wc -l) image manifests"
    fi

    github_install_layers

  else
    # Tarball installation
    tarball_verify_checksums
    tarball_install_binaries

    if [[ -n "${zpool_dev}" ]]; then
      info "creating flynn-default zpool"
      run zpool create ${zpool_opts} "flynn-default" ${zpool_dev}
    fi

    tarball_install_manifests
    tarball_install_image_manifests
    tarball_install_layers
  fi

  # Record installation source
  info "recording installation source..."
  cat > "${CONFIG_DIR}/install-source.json" <<EOF
{
  "source": "${INSTALL_SOURCE}",
  "repository": "${GITHUB_REPO}",
  "version": "${VERSION}",
  "installed_at": "$(date -Iseconds)"
}
EOF

  install_systemd_unit

  info "installation complete!"
  if [[ "${INSTALL_SOURCE}" == "github" ]]; then
    info "Flynn will use GitHub Releases for future updates."
    info "Run 'flynn-host update' to check for and install updates."
  else
    info "Run 'systemctl start flynn-host' to start the Flynn host daemon."
  fi
}

main "$@"

