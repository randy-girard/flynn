#!/bin/bash

set -e

ROOT="$(cd "$(dirname "$0")/.." && pwd)"
source "${ROOT}/script/lib/ui.sh"

usage() {
  cat <<USAGE >&2
usage: $0 [options]

Build Flynn using the builder image.

OPTIONS:
  -h, --help              Show this message
  -v, --verbose           Be verbose
  -x, --version=VERSION   Explicit version to use [default: dev]
  -f, --force-bootstrap   Force bootstrap
  --host=HOST             Host to run the build on
  --git-version           Generate the version using git status
USAGE
}

main() {
  local host=""
  local version="dev"
  local verbose=false
  local force_bootstrap=false

  while true; do
    case "$1" in
      -h | --help)
        usage
        exit 0
        ;;
      --host)
        if [[ -z "$2" ]]; then
          fail "--host flag requires an argument"
        fi
        host="$2"
        shift 2
        ;;
      -v | --verbose)
        verbose=true
        shift
        ;;
      -f | --force-bootstrap)
        force_bootstrap=true
        shift
        ;;
      -x | --version)
        if [[ -z "$2" ]]; then
          fail "--version flag requires an argument"
        fi
        version="$2"
        shift 2
        ;;
      --git-version)
        version="$(git_version)"
        shift
        ;;
      *)
        break
        ;;
    esac
  done

  if [[ $# -ne 0 ]]; then
    usage
    exit 1
  fi

  local flynn_host="${ROOT}/build/bin/flynn-host"
  local builder_image="${ROOT}/build/image/builder.json"

  # Build binaries locally using Go instead of downloading from flynn.io
  # Note: flynn-host download functionality is preserved for future use
  if ! [[ -e "${flynn_host}" ]] || $force_bootstrap; then
    info "building Flynn binaries from source using Go"

    # Ensure Go is available
    if ! command -v go &> /dev/null; then
      fail "Go is not installed. Please install Go 1.13 or later."
    fi

    # kill existing cluster to unlock the volume database
    "${ROOT}/script/kill-flynn" || true

    mkdir -p "${ROOT}/build/bin"
    mkdir -p "${ROOT}/build/manifests"
    mkdir -p "${ROOT}/build/image"

    # Set up Go build environment
    export GO111MODULE=on
    export GOFLAGS=-mod=vendor
    export CGO_ENABLED=1

    info "building flynn-host binary (with download capability)"
    cd "${ROOT}"
    go build -o "${flynn_host}" ./host
    chmod +x "${flynn_host}"

    info "building flynn-init binary"
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/flynn-init" ./host/flynn-init
    chmod +x "${ROOT}/build/bin/flynn-init"

    info "building flynn-builder binary"
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/flynn-builder" ./builder
    chmod +x "${ROOT}/build/bin/flynn-builder"

    info "building discoverd binary"
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/discoverd" ./discoverd
    chmod +x "${ROOT}/build/bin/discoverd"

    info "building flynn CLI binaries"
    for platform in "linux/amd64" "linux/386" "darwin/amd64" "windows/amd64" "windows/386"; do
      GOOS="${platform%/*}"
      GOARCH="${platform#*/}"
      output="${ROOT}/build/bin/flynn-${GOOS}-${GOARCH}"
      if [[ "${GOOS}" == "windows" ]]; then
        output="${output}.exe"
      fi
      info "  building flynn-${GOOS}-${GOARCH}"
      CGO_ENABLED=0 GOOS="${GOOS}" GOARCH="${GOARCH}" go build -o "${output}" ./cli
      chmod +x "${output}" 2>/dev/null || true
    done
    ln -nfs "flynn-linux-amd64" "${ROOT}/build/bin/flynn"

    info "building other Flynn components"
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/flynn-controller" ./controller
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/flynn-scheduler" ./controller/scheduler
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/flynn-worker" ./controller/worker
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/flynn-router" ./router
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/flynn-acme" ./router/acme    
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/flanneld" ./flannel
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/flynn-logaggregator" ./logaggregator
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/flynn-release" ./util/release
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/flynn-test-file-server" ./test

    info "building database appliance binaries"
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/flynn-postgres" ./appliance/postgresql/cmd/flynn-postgres
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/flynn-postgres-api" ./appliance/postgresql/cmd/flynn-postgres-api
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/flynn-mariadb" ./appliance/mariadb/cmd/flynn-mariadb
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/flynn-mariadb-api" ./appliance/mariadb/cmd/flynn-mariadb-api
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/flynn-mongodb" ./appliance/mongodb/cmd/flynn-mongodb
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/flynn-mongodb-api" ./appliance/mongodb/cmd/flynn-mongodb-api
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/flynn-redis" ./appliance/redis/cmd/flynn-redis
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/flynn-redis-api" ./appliance/redis/cmd/flynn-redis-api

    info "building additional Flynn services"
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/flynn-blobstore" ./blobstore
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/gitreceived" ./gitreceive
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/flynn-receiver" ./gitreceive/receiver
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/tarreceive" ./tarreceive
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/taffy" ./taffy
    CGO_ENABLED=0 go build -o "${ROOT}/build/bin/flynn-updater" ./updater

    # Create a minimal builder image manifest
    # This is needed for the flynn-builder to work
    cat > "${builder_image}" <<EOF
{
  "meta": {
    "manifest.id": "local-build"
  }
}
EOF

    # Note: The flynn-host binary now includes the 'download' command which can be used
    # to download images and binaries from a TUF repository when needed:
    #
    # Example usage:
    #   "${flynn_host}" download \
    #     --repository "https://your-tuf-repo/tuf" \
    #     --tuf-db     "/tmp/tuf.db" \
    #     --bin-dir    "${ROOT}/build/bin" \
    #     --config-dir "${ROOT}/build/manifests" \
    #     --volpath    "/var/lib/flynn/volumes-0"
  fi

  # Set up GOROOT symlinks for unit tests
  # Use the system Go installation instead of extracting from an image
  if command -v go &> /dev/null; then
    local go_root="$(go env GOROOT)"
    if [[ -n "${go_root}" ]] && [[ -d "${go_root}" ]]; then
      info "setting up Go environment for tests"
      mkdir -p "${ROOT}/build/_go"

      # Create symlink to system Go installation
      if [[ ! -L "${ROOT}/build/_go" ]] || [[ "$(readlink ${ROOT}/build/_go)" != "${go_root}" ]]; then
        rm -rf "${ROOT}/build/_go"
        ln -nfs "${go_root}" "${ROOT}/build/_go"
      fi

      # Symlink go binaries
      ln -nfs "${go_root}/bin/go"    "${ROOT}/build/bin/go"
      ln -nfs "${go_root}/bin/gofmt" "${ROOT}/build/bin/gofmt"
    fi
  fi

  #cp ./bootstrap/manifest_template.json ./build/manifests/bootstrap-manifest.json
  #cp ./util/release/images_template.json ./build/manifests/images.json

  info "Flynn build complete!"
  info "Binaries are available in ${ROOT}/build/bin"
}

git_version() {
  local commit="$(git rev-parse --short HEAD)"
  if [[ -z "${commit}" ]]; then
    fail "unable to determine Git commit"
  fi

  # if there are tags like 'vYYYYMMDD.N' pointing at HEAD, use the most recent
  # one suffixed with the commit
  local tag="$(git tag --list "v*" --sort "v:refname" --points-at HEAD 2>/dev/null | tail -n 1)"
  if [[ -n "${tag}" ]]; then
    echo "${tag}-${commit}"
    return
  fi

  # use the branch and commit, appending a '+' if the index is dirty
  local branch="$(git rev-parse --abbrev-ref HEAD)"
  local version="${branch}-${commit}"
  if [[ -n "$(git status --porcelain)" ]]; then
    version="${version}+"
  fi
  echo "${version}"
}

main "$@"
